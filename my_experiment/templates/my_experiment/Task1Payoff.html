{% extends "global/Page.html" %}
{% block content %}
  <h3>Task 1 Results</h3>
  <hr>
  <div style="display:flex;gap:40px;justify-content:center;align-items:flex-start;">
    <div style="text-align:center;">
      <div><strong>Chosen Lottery</strong></div>
      <canvas id="chosenWheelStatic" width="300" height="300"></canvas>
    </div>
    {% if is_treatment %}
    <div style="text-align:center;">
      <div><strong>Unchosen Lottery</strong></div>
      <canvas id="unchosenWheelStatic" width="300" height="300"></canvas>
    </div>
    {% endif %}
  </div>

  <p class="fs-5">Your initial endowment was <strong>{{ initial }}</strong> tokens.</p>
  <p class="fs-5">After Task 1, you are left with <strong>{{ final_str }}</strong> tokens.</p>
  {% if is_treatment %}
  <p class="fs-5 text-danger">
    Had you chosen the other lottery, you would have been left with
    <u><strong>{{ unchosen_total_str }}</strong></u> tokens. <!-- todo: also tell them how much it is compared to the chosen outcome -->
  </p>
  {% endif %}
  <div class="d-flex justify-content-end">
    {{ next_button }}
  </div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const chosenProbs    = {{ chosen_probs|safe }},
        unchosenProbs  = {{ unchosen_probs|safe }},
        stoppedAngRad  = ({{ stopped_angle }} * Math.PI/180),
        isTreatment = "{{ treatment }}" === "treatment";

  const radius = 140, center={x:150,y:150};
  function drawWheel(ctx,probs){
    let start= Math.PI/2, colors=['#2bc31f','#d70000'];
    probs.forEach((p,i)=>{let slice=p*2*Math.PI;
      ctx.beginPath();
      ctx.moveTo(center.x,center.y);
      ctx.arc(center.x,center.y,radius,start,start+slice);
      ctx.fillStyle=colors[i];
      ctx.fill(); start+=slice;
    });
  }
  function drawArrow(ctx,angle){
    const L=radius*1.5,h=15,half=L/2,tail=-half,tip=half,base=tip-h;
    ctx.save();
    ctx.translate(center.x,center.y);
    ctx.rotate(angle);
    // shaft
    ctx.beginPath();ctx.moveTo(tail,0);ctx.lineTo(base,0);
    ctx.strokeStyle='black';ctx.lineWidth=4;ctx.lineCap='round';ctx.stroke();
    // head
    ctx.beginPath();ctx.moveTo(tip,0);
    ctx.lineTo(base,h);ctx.lineTo(base,-h);
    ctx.closePath();ctx.fillStyle='black';ctx.fill();
    ctx.restore();
  }

  // chosen
  let cCtx=document.getElementById('chosenWheelStatic').getContext('2d');
  drawWheel(cCtx,chosenProbs);
  drawArrow(cCtx,stoppedAngRad);
  // unchosen
  if(isTreatment){
    let uCtx=document.getElementById('unchosenWheelStatic').getContext('2d');
    drawWheel(uCtx,unchosenProbs);
    drawArrow(uCtx,stoppedAngRad);
  }
})();
</script>
{% endblock %}
